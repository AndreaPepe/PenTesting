#+title: HTB - Late
#+author: Andrea Pepe
#+date: 06/05/2022

* Foothold
** nmap
   #+begin_example
$ sudo nmap -sC -sV late                  
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-06 15:23 CEST
Nmap scan report for late (10.10.11.156)
Host is up (0.096s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.6 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 02:5e:29:0e:a3:af:4e:72:9d:a4:fe:0d:cb:5d:83:07 (RSA)
|   256 41:e1:fe:03:a5:c7:97:c4:d5:16:77:f3:41:0c:e9:fb (ECDSA)
|_  256 28:39:46:98:17:1e:46:1a:1e:a1:ab:3b:9a:57:70:48 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
|_http-title: Late - Best online image tools
|_http-server-header: nginx/1.14.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 17.64 seconds   
   #+end_example

   #+begin_example
$ sudo nmap -p- late                                                                    
[sudo] password di andrea: 
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-06 15:24 CEST
Stats: 0:00:56 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 26.08% done; ETC: 15:28 (0:02:39 remaining)
Nmap scan report for late (10.10.11.156)
Host is up (0.068s latency).
Not shown: 65532 closed tcp ports (reset)
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
9004/tcp open  unknown

Nmap done: 1 IP address (1 host up) scanned in 94.79 seconds
   #+end_example

   #+begin_example
$ sudo nmap -p9004 -sC -sV late                                                   
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-06 15:28 CEST
Stats: 0:00:11 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Service scan Timing: About 0.00% done
Nmap scan report for late (10.10.11.156)
Host is up (0.050s latency).

PORT     STATE SERVICE VERSION
9004/tcp open  http    SimpleHTTPServer 0.6 (Python 3.6.9)
|_http-title: Directory listing for /
|_http-server-header: SimpleHTTP/0.6 Python/3.6.9

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 14.59 seconds   
   #+end_example

** Web Server
*** Port 80
Il server HTTP sulla porta classica 80 tcp non sembra essere molto
interessante, fatta eccezione per un form ~contact us~ e una mail che
potrebbe tornare utile in futuro: ~support@late.htb~.

*** Port 9004
Il server espone i seguenti files scaricabili:
- *authorized_keys*
- *id_rsa*
- *id_rsa.pub*
- *known_hosts*

#+begin_example
$ cat id_rsa.pub                                                                                            1 ⚙
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCp7ldYUpWqV4LJ/M+jgex9FHy4X8//dOf5+IBQeGca8EEDKsweI/dL8Oep0gfa6pNd0+Th4Z1fKfMycVHNthv5wFr5HxP+dNrc9K5H22SKqFdNoQ5uCNFLKevY24NY9CFfw6aEAp0mFl8StlRxvGK6dysqegKVktDplkNo1O1NTClRoyL+a1ofMsgPUpOX51QWwtBiZ1FQDrf3GTPVi8MXk5sgOh4eA5TutlXhOoDqzqAjtbt3Xfszc6LZZNZEHNxZMAzB9InZwS229L8CcT8HYR6WPWyFhRm4/IiguFIyJwaeEHvsgqll5D4yCSxFwcnl8naG9O79PfIv22CB/0Ox svc_acc@late
#+end_example

Dalla chiave pubblica riusciamo a capire l'utente da usare per
accedere con ssh: ~svc_acc~

Usiamo la chiave privata per provare ad accedere:
#+begin_example
$ cat id_rsa                                                                                                1 ⚙
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAqe5XWFKVqleCyfzPo4HsfRR8uF/P/3Tn+fiAUHhnGvBBAyrM
HiP3S/DnqdIH2uqTXdPk4eGdXynzMnFRzbYb+cBa+R8T/nTa3PSuR9tkiqhXTaEO
bgjRSynr2NuDWPQhX8OmhAKdJhZfErZUcbxiuncrKnoClZLQ6ZZDaNTtTUwpUaMi
/mtaHzLID1KTl+dUFsLQYmdRUA639xkz1YvDF5ObIDoeHgOU7rZV4TqA6s6gI7W7
d137M3Oi2WTWRBzcWTAMwfSJ2cEttvS/AnE/B2Eelj1shYUZuPyIoLhSMicGnhB7
7IKpZeQ+MgksRcHJ5fJ2hvTu/T3yL9tggf9DsQIDAQABAoIBAHCBinbBhrGW6tLM
fLSmimptq/1uAgoB3qxTaLDeZnUhaAmuxiGWcl5nCxoWInlAIX1XkwwyEb01yvw0
ppJp5a+/OPwDJXus5lKv9MtCaBidR9/vp9wWHmuDP9D91MKKL6Z1pMN175GN8jgz
W0lKDpuh1oRy708UOxjMEalQgCRSGkJYDpM4pJkk/c7aHYw6GQKhoN1en/7I50IZ
uFB4CzS1bgAglNb7Y1bCJ913F5oWs0dvN5ezQ28gy92pGfNIJrk3cxO33SD9CCwC
T9KJxoUhuoCuMs00PxtJMymaHvOkDYSXOyHHHPSlIJl2ZezXZMFswHhnWGuNe9IH
Ql49ezkCgYEA0OTVbOT/EivAuu+QPaLvC0N8GEtn7uOPu9j1HjAvuOhom6K4troi
WEBJ3pvIsrUlLd9J3cY7ciRxnbanN/Qt9rHDu9Mc+W5DQAQGPWFxk4bM7Zxnb7Ng
Hr4+hcK+SYNn5fCX5qjmzE6c/5+sbQ20jhl20kxVT26MvoAB9+I1ku8CgYEA0EA7
t4UB/PaoU0+kz1dNDEyNamSe5mXh/Hc/mX9cj5cQFABN9lBTcmfZ5R6I0ifXpZuq
0xEKNYA3HS5qvOI3dHj6O4JZBDUzCgZFmlI5fslxLtl57WnlwSCGHLdP/knKxHIE
uJBIk0KSZBeT8F7IfUukZjCYO0y4HtDP3DUqE18CgYBgI5EeRt4lrMFMx4io9V3y
3yIzxDCXP2AdYiKdvCuafEv4pRFB97RqzVux+hyKMthjnkpOqTcetysbHL8k/1pQ
GUwuG2FQYrDMu41rnnc5IGccTElGnVV1kLURtqkBCFs+9lXSsJVYHi4fb4tZvV8F
ry6CZuM0ZXqdCijdvtxNPQKBgQC7F1oPEAGvP/INltncJPRlfkj2MpvHJfUXGhMb
Vh7UKcUaEwP3rEar270YaIxHMeA9OlMH+KERW7UoFFF0jE+B5kX5PKu4agsGkIfr
kr9wto1mp58wuhjdntid59qH+8edIUo4ffeVxRM7tSsFokHAvzpdTH8Xl1864CI+
Fc1NRQKBgQDNiTT446GIijU7XiJEwhOec2m4ykdnrSVb45Y6HKD9VS6vGeOF1oAL
K6+2ZlpmytN3RiR9UDJ4kjMjhJAiC7RBetZOor6CBKg20XA1oXS7o1eOdyc/jSk0
kxruFUgLHh7nEx/5/0r8gmcoCvFn98wvUPSNrgDJ25mnwYI0zzDrEw==
-----END RSA PRIVATE KEY-----
#+end_example

#+begin_example
$ ssh -i id_rsa svc_acc@late                                                                                1 ⚙
-bash-4.4$ pwd
/home/svc_acc
#+end_example

We are in!

* Privilege Escalation
** svc_acc
*** user flag
    #+begin_example
-bash-4.4$ cat user.txt 
1428c4af35c7fc9b1c4e2a03fac2bcc0
    #+end_example
*** app
Nella home directory dell'utente, c'è una cartella nominata *app*, in
cui c'è il seguente codice (*main.py*):
#+begin_src python
import datetime
import os, random
from flask.templating import render_template_string
from werkzeug.utils import secure_filename
import PIL.Image
import pytesseract
from PIL import Image
from flask import Flask, request, render_template, redirect, url_for, session, send_file

app = Flask(__name__)

upload_dir = "/home/svc_acc/app/uploads"
misc_dir = '/home/svc_acc/app/misc'
allowed_extensions =  ["jpg" ,'png']
app.secret_key = b'_5#y2L"F4Q8z\n\xec]/'


@app.route('/')
def home():
    return render_template("index.html", title="Image Reader")
#+end_src

C'è inoltre il seguente file *wsgi.py*
#+begin_src pyhton
from main import app
 
if __name__ == '__main__':
    app.run(debug=False, host="0.0.0.0", port=50816)
#+end_src

